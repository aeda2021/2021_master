---
title: "Eine Einführung in GLMMs"
author: "Adaptiert von M. Pinsky aus Zuur et al. 2009 Kap. 21 und dem DHARMa-Tutorial"
date: "30/03/2021"
output:
    github_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ncf)
require(glmmTMB)
require(DHARMa)
```

## Einführung
Die Vorhersage der räumlichen Verteilung von Wildtierpopulationen ist eine wichtige Komponente bei der Entwicklung von Managementstrategien zu deren Erhaltung. Landschaftsstruktur und -zusammensetzung sind wichtige Determinanten dafür, wo Arten vorkommen und wie lebensfähig ihre Populationen sind. In dieser Übung modellieren wir die Auswirkungen der Landschaftsstruktur auf die Verbreitung von Koalas (_Phascolarctos cinereus_) in einer Landschaft im Osten Australiens. 

Das Untersuchungsgebiet, das wir für dieses Kapitel betrachten, ist die Noosa Local Government Area (LGA) im Südosten Queenslands, Australien (Abb. 21.2). Noosa hat ein subtropisches Küstenklima. Über 50 % der ursprünglichen Eukalyptuswälder wurden für Landwirtschaft und Stadtentwicklung gerodet. Koalas sind daher durch den Verlust und die Fragmentierung ihres Lebensraums sowie durch Bedrohungen im Zusammenhang mit der Verstädterung, wie Autos und Haushunde, bedroht. 

Wir werden verallgemeinerte lineare Modelle mit gemischten Effekten (GLMM) verwenden, um die Verbreitung von Koalas zu modellieren, indem wir Daten über ihre An- und Abwesenheit an Standorten im gesamten Untersuchungsgebiet verwenden. Wir verfolgen auch einen multiskaligen Ansatz in dem Sinne, dass unsere erklärenden Variablen Landschaftscharakteristika sind, die an verschiedenen Landschaftsausmaßen gemessen werden. Die Analyse konzentriert sich auf den Umgang mit Kollinearität und räumlicher Autokorrelation für diese Arten von Landschaftsmodellen.

## Daten
Die vorgestellten Daten basieren auf Erhebungen, die durchgeführt wurden, um die Anwesenheit oder Abwesenheit von Koalas an 300 Orten in Noosa zu bestimmen. Unter Verwendung einer Form von geschichteten Zufallsstichproben wurden zunächst 100 Standorte in der gesamten LGA von Noosa festgelegt. Dann wurden innerhalb jedes Standorts drei Unterstandorte im Abstand von 100 m festgelegt. An jedem Teilstandort wurde dann die Anwesenheit oder Abwesenheit von Koalas durch eine standardisierte Suche nach Koala-Kotpellets an den Basen von Bäumen bestimmt. In früheren Arbeiten wurden die bevorzugten Baumarten der Koalas in Noosa identifiziert und in primäre, sekundäre und ergänzende Arten unterteilt. An jedem Teilstandort wurde der prozentuale Anteil der Bäume, die primäre und sekundäre Arten waren, aufgezeichnet. Schließlich wurde die Verteilung des Koala-Habitats (klassifiziert in sehr geeignetes, geeignetes, marginales und ungeeignetes Habitat) kartiert. 

Die Daten zur Anwesenheit/Abwesenheit von Koalas bilden die Antwortvariable für unsere Analyse, während die Daten zu den bevorzugten Baumarten und zum Lebensraum die Grundlage für die erklärenden Variablen bilden.

Der Datenrahmen enthält eine Zeile für jeden Teilstandort. Die Spalten:

- `site`: Standort-ID
- `subsite`: Unterseiten-ID-Nummern
- `easting`: Östungen der Lage der einzelnen Teilstandorte (in AMG ADG 1966-Koordinaten)
- `northing`: Nördlingen 
- `presence`: ob Koala-Pellets an der Teilfläche gefunden wurden (= 1) oder nicht an der Teilfläche gefunden wurden (= 0)
- `pprim_ssite`: %Bäume in jeder Teilfläche, die primäre Baumarten sind
- `psec_ssite`: %Bäume in jeder Teilfläche, die sekundäre Baumarten sind
- `pdens_1km`: Dichte der Habitatfelder (Felder/100 ha), bestehend aus sehr geeignetem plus geeignetem plus marginalem Habitat, in der Landschaft im Umkreis von 1 km von jedem Teilstandort
 
```{r}
koalas <- readRDS(url('https://github.com/aeda2021/2021_master/raw/main/raw-data/koalas.rds'))
```

## Datenuntersuchung
Zwei wichtige Punkte, die vor der Erstellung von Regressionsmodellen für die Verteilung von Arten zu berücksichtigen sind, sind, ob eine hohe Kollinearität zwischen den erklärenden Variablen besteht und ob die räumliche Autokorrelation zwischen Datenpunkten wahrscheinlich ein wichtiger Faktor ist. Hohe Kollinearität kann zu Koeffizientenschätzungen führen, die schwer als unabhängige Effekte zu interpretieren sind und/oder hohe Standardfehler aufweisen. Eine positive räumliche Autokorrelation verstößt gegen die übliche Annahme der Unabhängigkeit zwischen Datenpunkten und führt zu einer Unterschätzung der Standardfehler und zu erhöhten Fehlern vom Typ I, wenn sie nicht berücksichtigt werden. Kollinearität zwischen erklärenden Variablen und räumliche Autokorrelation sind häufig anzutreffen, wenn Beobachtungsdaten zur Konstruktion von Regressionsmodellen der Verteilung von Arten verwendet werden. Für diese beiden Probleme untersuchen wir, ob sie wahrscheinlich ein Problem für die Analyse unseres Datensatzes darstellen und diskutieren dann, wie sie angegangen werden können.

### Diagramme
Beginnen wir damit, einige Diagramme der Antwortvariablen im Vergleich zu jeder der erklärenden Variablen zu erstellen. Es ist auch hilfreich, eine Karte zu erstellen (Darstellung der Antwort als Punktfarbe im Vergleich zu Nord- und Ostrichtung)
```{r}

```

### Kollinearität auswerten
Ein einfacher erster Schritt zur Identifizierung von Kollinearität ist die Betrachtung der paarweisen Korrelationen zwischen den erklärenden Variablen. Wir verwenden den Spearman-Rangkorrelationskoeffizienten und nicht den Pearson-Korrelationskoeffizienten, weil die Spearman-Rangkorrelation keine Annahmen über die Linearität der Beziehung zwischen den beiden Variablen macht. Eine grobe Richtlinie ist, dass Korrelationen zwischen Variablenpaaren mit Größenordnungen größer als ±0,5 auf eine hohe Kollinearität hinweisen.

Es gibt mehrere Strategien, die wir verwenden können, um mit der gefundenen Kollinearität zwischen den erklärenden Variablen umzugehen. Dazu gehören (i) das einfache Entfernen einer oder mehrerer Variablen, so dass die verbleibenden Variablen nicht hoch korreliert sind, (ii) die Verwendung von Linearkombinationen der Variablen anstatt der Variablen direkt im Modell, oder (iii) die Verwendung von verzerrten Schätzverfahren wie Hauptkomponentenregression oder Ridge-Regression. Die ersten beiden sind am einfachsten.

Die erklärenden Variablen befinden sich in den Spalten 6:8, so dass ein einfacher Ansatz darin besteht, `pairs()` und `cor(..., method = 'spearman')` auf `koalas[, 6:8]` zu verwenden. 

Bitte verwenden Sie den unten stehenden Codeblock.

```{r}
# hier tippen
```

#### Q1: Sehen Sie Anzeichen von Kolinearität, die Sie beunruhigen? Wenn ja, welche?




## Räumliche Autokorrelation auswerten
Es gibt zwei Gründe für die Erwartung einer räumlichen Autokorrelation in den Präsenz/Absenz-Daten. Erstens kann es zu einer räumlichen Autokorrelation auf der Ebene der Standorte kommen, weil die Entfernungen zwischen den Unterstandorten innerhalb der einzelnen Standorte im Verhältnis zur Größe der Koala-Heimatgebiete klein sind. Die durchschnittliche Größe der Koala-Heimatgebiete in ähnlichen Lebensräumen an der Ostküste wurde auf 10-25 ha für Weibchen und 20-90 ha für Männchen geschätzt. Daher werden die Vorkommen von Koalas an Teilstandorten innerhalb eines einzelnen Standorts tendenziell korreliert sein, da sie sich oft innerhalb des Heimatgebiets desselben Koalas befanden. 

Zweitens kann eine räumliche Autokorrelation auf breiterer Skala aufgrund der räumlich begrenzten Ausbreitung von Koalas aus ihren ursprünglichen Heimatgebieten auftreten. Die Dispersionsdistanzen von Koalas in nahegelegenen Regionen wurden mit etwa 3-4 km angegeben, können aber auch bis zu 10 km betragen. Die Dispersionsdistanzen sind also wesentlich kleiner als die räumliche Ausdehnung des Untersuchungsgebiets, und dies könnte auch zu einer räumlichen Autokorrelation zwischen den Standorten führen. Wir könnten auch eine räumliche Autokorrelation in den Präsenz-/Absenzdaten sehen, wenn das zugrunde liegende räumliche Muster des Lebensraums räumlich autokorreliert ist. Wir würden jedoch erwarten, dass unsere erklärenden Variablen den größten Teil der räumlichen Autokorrelation aus dieser Quelle erklären, sobald das Regressionsmodell an die Daten angepasst ist, und daher als weniger besorgniserregend angesehen wird.

Eine Möglichkeit, das Ausmaß der räumlichen Autokorrelation zu beurteilen, ist die Betrachtung von Korrelationsdiagrammen der Daten. Korrelationsdiagramme sind grafische Darstellungen der räumlichen Korrelation zwischen Orten in einem Bereich von Verzögerungsabständen. Eine positive räumliche Korrelation weist darauf hin, dass die räumliche Autokorrelation zwischen Datenpunkten ein Problem darstellen könnte. Negative räumliche Korrelation kann auch auf ein Problem hinweisen, aber das ist bei dieser Art von Daten eher ungewöhnlich; daher befassen wir uns hauptsächlich mit positiven Korrelationen. Wir verwenden ein Spline-Korrelogramm, um die Autokorrelation in den An-/Abwesenheitsdaten zu untersuchen. Das von uns verwendete Spline-Korrelogramm ist im Wesentlichen ein Korrelogramm, das mit einer Spline-Funktion geglättet wird. 

Wir werden uns zunächst die räumliche Autokorrelation in den Rohdaten ansehen. Wir sind jedoch vor allem daran interessiert, ob es eine räumliche Autokorrelation in den Modellresiduen gibt, nachdem jegliche räumliche Autokorrelation, die durch die erklärenden Variablen erklärt wird, berücksichtigt wurde.

Ein Spline-Korrelogramm der rohen An-/Abwesenheitsdaten kann mit dem folgenden Code gezeichnet werden. Die Funktion `spline.correlog()` führt 1000 Bootstraps durch, um 95% Konfidenzintervalle bis zu einer maximalen Lag-Distanz von 10 km zu berechnen und kann einige Minuten dauern.

```{r}
correlog <- spline.correlog(x = koalas$easting,
                            y = koalas$northing,
                            z = koalas$presence, 
                            xmax = 10000)
plot(correlog)
```
#### Q2: Sehen Sie eine positive räumliche Autokorrelation, über die wir uns Sorgen machen sollten? Wenn ja, auf welchen Skalen?




## Standardisieren der erklärenden Variablen
Bevor die Modelle an die Daten angepasst werden, sollten die erklärenden Variablen so standardisiert werden, dass sie jeweils einen Mittelwert von Null und eine Standardabweichung von Eins haben. Dies hilft, die Konvergenz des Anpassungsalgorithmus zu verbessern und bringt die geschätzten Koeffizienten auf die gleiche Skala, wodurch die Effektgrößen leichter verglichen werden können. Wir können die erklärenden Variablen standardisieren, indem wir eine Funktion auf jede der Spalten mit erklärenden Variablen anwenden:

```{r}
koalas_st <- cbind(koalas[, 1:5],
                   apply(X = koalas[, 6:ncol(koalas)], 
                         MARGIN = 2, 
                         FUN = function(x){(x - mean(x)) / sd(x)}
                         )
                   )
```

## Anpassen eines ersten Modells (GLM)
Unsere Antwortvariable ist Anwesenheit/Abwesenheit und wird daher keine schöne Gaußsche Verteilung haben. Bitte wählen Sie eine geeignetere Fehlerverteilung und passen Sie ein `glm()` mit Anwesenheit als Antwortvariable und `pprim_ssite`, `psec_ssite`, und `pdens_1km` als erklärende Variablen an.  Verwenden Sie `koalas_st` als Datenquelle, da sie die standardisierten Variablen enthält. Speichern Sie Ihr Modell in `mod_glm`, damit es mit einem späteren Code, den wir verwenden werden, funktioniert.

```{r}

```

Verwenden Sie sicherheitshalber `summary()`, um einen kurzen Blick darauf zu werfen:
```{r glmsum}

```

### Bewerten Sie das Modell
Wie gut passt unser Modell? Die Auswertung von GLM(M)s kann schwierig sein, schauen wir uns das mit dem DHARMa-Paket an. Wie Sie lesen, sind die grundlegenden Schritte

- Simulieren Sie neue Daten mit dem angepassten Modell für jede Beobachtung.
- Berechnen Sie für jede Beobachtung die empirische kumulative Dichtefunktion für die simulierten Beobachtungen, die die möglichen Werte (und deren Wahrscheinlichkeit) bei der Prädiktorenkombination des beobachteten Wertes beschreibt, unter der Annahme, dass das angepasste Modell korrekt ist.
- Das Residuum ist dann definiert als der Wert der empirischen Dichtefunktion bei dem Wert der beobachteten Daten, so dass ein Residuum von 0 bedeutet, dass alle simulierten Werte größer als der beobachtete Wert sind, und ein Residuum von 0,5 bedeutet, dass die Hälfte der simulierten Werte größer als der beobachtete Wert sind.

Wenn die beobachteten Daten aus demselben datenerzeugenden Prozess erzeugt wurden, aus dem wir simulieren, sollten alle Werte der kumulativen Verteilung mit gleicher Wahrscheinlichkeit auftreten. Das heißt, wir erwarten, dass die Verteilung der Residuen flach ist, unabhängig von der Modellstruktur (Poisson, Binomial, zufällige Effekte und so weiter).

Der erste Schritt ist die Simulation der randomisierten Quantilresiduen. Die Voreinstellung ist 250 Simulationen.
```{r glmres}
res_glm <- simulateResiduals(fittedModel = mod_glm, plot = F)
```

Dann plotten Sie sie. 
```{r glmplot}
plot(res_glm)
```

Links ist ein qq-Plot zur Erkennung von Gesamtabweichungen von der erwarteten Verteilung, standardmäßig mit zusätzlichen Tests auf korrekte Verteilung (KS-Test), Streuung und Ausreißer. Wir wollen, dass die Residuen (schwarze Punkte) auf der roten Linie für die erwartete Verteilung liegen. Der DHARMa-Tutorial-Abschnitt über "Erkennen von Über-/Unterdispersion" ist gut geeignet, um Abweichungen davon zu interpretieren. 

Auf der rechten Seite ist ein Diagramm der Residuen gegen den vorhergesagten Wert zu sehen. Simulationsausreißer sind als rote Sterne hervorgehoben. Diese Punkte sollten vorsichtig interpretiert werden, da wir eigentlich nicht wissen, "wie sehr" diese Werte von der Modellerwartung abweichen. Beachten Sie, dass Ausreißer in DHARMa Werte sind, die standardmäßig als Werte außerhalb der Simulationshüllkurve definiert sind, nicht in Bezug auf ein bestimmtes Quantil. Beachten Sie auch, dass die Wahrscheinlichkeit eines Ausreißers von der Anzahl der Simulationen abhängt. Ob das Vorhandensein von Ausreißern ein Grund zur Besorgnis ist, hängt also auch von der Anzahl der Simulationen ab (n=250 oben).

Um eine visuelle Hilfe bei der Erkennung von Abweichungen von der Gleichmäßigkeit in y-Richtung zu bieten, berechnet die Plot-Funktion eine Quantilsregression, die die empirischen 0,25-, 0,5- und 0,75-Quantile in y-Richtung (durchgezogene Linien) mit den theoretischen 0,25-, 0,5- und 0,75-Quantilen (gestrichelte schwarze Linie) vergleicht und einen p-Wert für die Abweichung vom erwarteten Quantil liefert. Die Signifikanz der Abweichung zu den erwarteten Quantilen wird getestet und visuell dargestellt.

#### Q3: Bewerten Sie den QQ-Plot und die Residuen vs. vorhergesagte Plots. Wenn Sie Bedenken sehen, beschreiben Sie diese bitte.


### Auswertung der räumlichen Autokorrelation im GLM
Wir waren besorgt über die räumliche Autokorrelation in unseren Rohdaten, also wollen wir sehen, ob die Einbeziehung der erklärenden Variablen dieses Problem löst. Verwenden Sie denselben Code, den Sie zuvor für das Spline-Korrelogramm verwendet haben, aber verwenden Sie jetzt `resid(mod_glm)` als z-Achse.

```{r glmspatial}


```


#### Q4: Sehen Sie Hinweise auf eine räumliche Autokorrelation in den Residuen? Auf welcher räumlichen Skala? Wie hängt dies mit dem Studiendesign zusammen?



## Anpassen eines GLMM
Wie Sie in der Lektüre gelernt haben, sind GLMMs nützlich, wenn die Daten in irgendeiner Weise hierarchisch strukturiert sind. Sie berücksichtigen Abhängigkeiten innerhalb hierarchischer Gruppen durch die Einführung von Zufallseffekten. In dieser Studie sind die Daten in dem Sinne hierarchisch strukturiert, dass Unterseiten innerhalb von Standorten verschachtelt sind, und wir möchten Modelle mit gemischten Effekten verwenden, um die räumlichen Abhängigkeiten innerhalb der Standorte zu berücksichtigen. Ein geeignetes Modell mit gemischten Effekten für diese Zwecke kann konstruiert werden, indem ein Zufallseffekt für den Standort in das Standardmodell der logistischen Regression eingeführt wird.

Wie Sie auch gelesen haben (z.B. Ben Bolker's FAQ), sind GLMMs nicht einfach zu fitten oder zu interpretieren. Die Methoden werden ständig weiterentwickelt. Hier werden wir das glmmTMB-Paket verwenden, das von Ben Bolker entwickelt wurde. Als Anmerkung, es hat auch einige nette Funktionen für die Berücksichtigung von null-inflationären Daten und Heteroskedastizität, auf die wir heute nicht eingehen werden.

Die Syntax für glmmTMB ist wie `lmer()` in lme4 und wie `glm()`, was schön ist. Siehe `?glmmTMB` für weitere Informationen.
```
Modell <- glmmTMB(Antwort ~ erklärendeVariablen + (1|zufällig), data=meineDaten, family=Familie) # ein zufälliges Intercept-Modell
Modell <- glmmTMB(Antwort ~ erklärendeVariablen + (Neigung|zufällig), data=meineDaten, family=Familie) # ein zufälliges Intercept- und Slope-Modell
```

Hier verwenden wir `site` als Zufallseffekt, um die räumliche Autokorrelation und Pseudoreplikation auf dieser Skala zu berücksichtigen.

Im folgenden Code-Block fitten Sie ein GLMM mit `glmmTMB()` mit `pprim_ssite`, `psec_ssite` und `pdens_1km` als erklärende Variablen (wie Ihr GLM) und `site` als zufälligen Intercept. Stellen Sie sicher, dass Sie eine Familie wählen, die für diese Daten sinnvoll ist. Verwenden Sie `koalas_st` als Ihre Datenquelle und speichern Sie unter `mod_glmm`.
```{r}


```

Werfen Sie einen Blick mit `summary()` auf Ihr GLMM.
```{r}


```

### Das Modell auswerten
Fahren Sie fort und bewerten Sie Ihr GLMM mit 

- DHARMa simulierten Residuen und Standardplots
- ein räumliches Korrelogramm der Residuen

wie Sie es für das GLM getan haben. 

```{r}



```


Es ist auch sinnvoll, die Residuen gegen jede der erklärenden Variablen aufzutragen. Sie können dies in DHARMa mit der Syntax
```
plotResiduals(SimulationAusgang, IhreDaten$variabel)
```

Führen Sie dies für die drei erklärenden Variablen unten durch:
```{r}


```

#### Q5: Bewerten Sie das QQ-Diagramm, das Residuen vs. vorhergesagtes Diagramm, das Spline-Korrelogramm und die Residuen vs. explorative Variablen. Gibt es irgendetwas, das Sie beunruhigt?



## Anpassen eines alternativen GLMMs
Wir können auch zwischen GLMMs mit AIC vergleichen. Passen Sie ein neues GLMM wie Ihr erstes an, aber nur mit Variablen auf der Site-Skala (nur `pprim_ssite` und `psec_ssite`).

```{r}



```

### Vergleichen Sie die Modelle
Vergleichen Sie nun Ihre Modelle. Sie können die Syntax verwenden
```
AIC(Modell1, Modell2)
```

```{r}


```

#### Q6: Welches Modell erscheint nach AIC als parsimonisch? Was haben Sie über die räumlichen Verteilungen der Koalas gelernt?



Wenn Sie fertig sind, klicken Sie oben auf "Knit", um dies in ein Github-Dokument zu verwandeln, das auf Github schön angezeigt wird. Es wird auch ein Unterverzeichnis mit den Bilddateien darin erstellt. Commitieren Sie alles in Ihr Git-Repositorium und pushen Sie es auf Github. __Glückwunsch!__

If you made it to the end, congratulations! And April Fools! The English version is [here](https://github.com/aeda2021/2021_master/blob/5bc86b1818cbdd6efd1074cf7ecd980f28e97022/scripts/10_GLMMs.Rmd)